stages:
  - deploy

deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client git bash
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H 13.222.186.214 >> ~/.ssh/known_hosts
  script:
    - ssh ubuntu@13.222.186.214 << 'EOF'
      cd /var/www/laravel || exit 1
      if [ ! -d ".git" ]; then
        git clone https://github.com/awsradhe/liveserverconnect.git .
      else
        git pull origin main
      fi
      composer install --no-interaction --prefer-dist --optimize-autoloader
      php artisan migrate --force
      php artisan config:cache
      php artisan route:cache
      php artisan view:cache
      sudo chown -R www-data:www-data /var/www/laravel
      sudo chmod -R 775 /var/www/laravel/storage
      exit
      EOF
  only:
    - main
